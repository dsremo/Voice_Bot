<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Striker VoiceBot</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="container">
    <h1>Striker VoiceBot</h1>
    <p id="instruction">Speak the wake‑up word “striker”</p>
    <p id="status">Waiting for wake‑up word…</p>
    <div id="chatLog"></div>
    <audio id="responseAudio" controls style="display:none;"></audio>
  </div>

  <script>
    // Check for browser support for SpeechRecognition.
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      document.getElementById('status').textContent = "Your browser does not support Speech Recognition.";
    } else {
      const recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = false;
      recognition.lang = 'en-US';

      let conversationActive = false;

      // Helper: update the status text.
      function updateStatus(text) {
        document.getElementById('status').textContent = text;
      }

      // Helper: append a message to the conversation log.
      function addChatMessage(sender, message) {
        const chatLog = document.getElementById('chatLog');
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chat-message');
        messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
        chatLog.appendChild(messageDiv);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      // Process recognized speech.
      recognition.onresult = async function(event) {
        // Get the latest recognized result.
        const transcript = event.results[event.results.length - 1][0].transcript.trim();
        console.log("Recognized:", transcript);

        // If conversation is not active, look for wake word.
        if (!conversationActive) {
          if (transcript.toLowerCase().includes("striker")) {
            conversationActive = true;
            updateStatus("Wake word detected. I'm listening...");
            addChatMessage("System", "Wake word detected. Conversation started.");
            // Send a "wake" command so the server responds with "I'm listening..."
            await sendMessage("wake");
          } else {
            updateStatus("Waiting for wake‑up word “striker”…");
          }
        } else {
          // In conversation mode.
          if (transcript.toLowerCase() === "exit" || transcript.toLowerCase() === "end") {
            conversationActive = false;
            updateStatus("Conversation ended. Speak the wake‑up word “striker” to start again.");
            addChatMessage("User", transcript);
            await sendMessage(transcript);
          } else {
            updateStatus("Processing: " + transcript);
            addChatMessage("User", transcript);
            await sendMessage(transcript);
          }
        }
      };

      recognition.onerror = function(event) {
        console.error("Speech recognition error:", event.error);
        updateStatus("Error: " + event.error);
      };

      recognition.onend = function() {
        console.log("Speech recognition ended, restarting...");
        recognition.start();
      };

      // Start continuous recognition.
      recognition.start();

      // Send the recognized text message to the server.
      async function sendMessage(message) {
        try {
          const response = await fetch('/chat_text', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: message })
          });
          if (response.ok) {
            const data = await response.json();
            const response_text = data.response_text;
            const audio_data = data.audio_data;
            addChatMessage("Striker", response_text);
            // Convert the base64 audio data to a Blob.
            const binary = atob(audio_data);
            const len = binary.length;
            const buffer = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
              buffer[i] = binary.charCodeAt(i);
            }
            const blob = new Blob([buffer], { type: "audio/wav" });
            const audioUrl = URL.createObjectURL(blob);
            const responseAudio = document.getElementById('responseAudio');
            responseAudio.src = audioUrl;
            responseAudio.style.display = 'block';
            responseAudio.play();
            updateStatus("Response received. Continue speaking...");
          } else {
            updateStatus("Server error.");
            console.error("Server responded with status", response.status);
          }
        } catch (err) {
          updateStatus("Error: " + err);
          console.error("Error sending message:", err);
        }
      }
    }
  </script>
</body>
</html>

